<!DOCTYPE html>

<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>TimeCure è´¢åŠ¡é¢åº¦çœ‹æ¿ï¼ˆSupabase ç‰ˆï¼‰</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<!-- SheetJS -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
    body { background: #f0f2f5; color:#333; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
    .container { max-width: 1600px; }
    .dashboard { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px; margin: 25px 0; }
    .client-card, .add-client-card { background:#fff; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.07); padding:25px; display:flex; flex-direction:column; align-items:center; position:relative; transition:all .3s ease; border:1px solid #e8e8e8; }
    .client-card:hover, .add-client-card:hover { box-shadow:0 8px 32px rgba(0,0,0,0.12); transform:translateY(-5px); }
    .add-client-card { justify-content:center; font-size:70px; color:#a0a0a0; cursor:pointer; border:2.5px dashed #d9d9d9; background:#fafafa; min-height:450px; }
    .add-client-card:hover { color:#0d6efd; border-color:#0d6efd; background:#f0f8ff; }
    .client-pie { width:180px; height:180px; margin:20px 0; }
    .pie-label-container { width:100%; text-align:center; margin-top:10px; min-height:50px; }
    .pie-label { display:inline-block; font-size:13px; margin:0 8px 5px 0; padding:3px 8px; border-radius:12px; font-weight:500; color:#fff; }
    .client-name { font-size:1.8rem; font-weight:700; color:#1a2747; margin-bottom:1rem; cursor:pointer; display:flex; align-items:center; gap:8px; }
    .info-row { font-size:1rem; color:#555; margin-bottom:.5rem;}
    .info-row b { color:#000; font-weight:600; }
    .quota-bar-wrapper { width:100%; height:25px; margin-top:15px; position:relative; }
    .quota-bar-bg { width:100%; height:100%; background:#e9ecef; border-radius:8px; position:relative; overflow:hidden; }
    .quota-bar-fill { height:100%; border-radius:8px; transition:width .6s ease-in-out; position:absolute; left:0; top:0; }
    .quota-bar-text { position:absolute; width:100%; text-align:center; top:50%; transform:translateY(-50%); color:#fff; font-size:14px; font-weight:bold; text-shadow:1px 1px 2px rgba(0,0,0,.5); }
    .warning-badge, .danger-badge { font-size:.8rem; padding:.2em .6em; border-radius:.8em; color:#fff; font-weight:600; }
    .warning-badge { background-color:#f7b731; }
    .danger-badge { background-color:#e74c3c; }
    .dashboard-title { font-size:2rem; font-weight:700; color:#1a2747; margin-bottom:1rem; }
    .action-bar { margin-bottom:1.5rem; display:flex; gap:1rem; align-items:center; }
    .modal-header { background:#1a2747; color:#fff; }
    .btn-close-white { filter: invert(1) grayscale(100%) brightness(200%); }
  </style>
</head>
<body><div id="connection-status" style="padding:8px; background:#eee; color:#333; font-size:14px;">æ­£åœ¨è¿æ¥ Supabase...</div>

<div id="debug-section" style="padding:10px; background:#f8f9fa; margin:10px 0; border-radius:8px;">
  <h5 style="margin:0 0 8px 0;">ğŸ”§ åŒ¿åå†™å…¥è°ƒè¯•ï¼ˆDebugï¼‰</h5>
  <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
    <button id="debug-insert-btn" class="btn btn-sm btn-outline-primary">æµ‹è¯•åŒ¿åæ’å…¥ï¼ˆä¸å« client_idï¼‰</button>
    <button id="debug-insert-client-btn" class="btn btn-sm btn-outline-secondary">æ’å…¥å®¢æˆ·å¹¶æ’å…¥è®°å½•ï¼ˆè‡ªåŠ¨ï¼‰</button>
    <button id="debug-clear-btn" class="btn btn-sm btn-outline-danger">æ¸…é™¤ test è®°å½•ï¼ˆä»… cost_records ä¸­çš„æµ‹è¯•æ¡ç›®ï¼‰</button>
    <span style="color:#666; font-size:13px;">ï¼ˆç”¨äºå®šä½æ˜¯å¦ä¸ºå¤–é”® / RLS / key é—®é¢˜ï¼‰</span>
  </div>
  <pre id="debug-result" style="background:#fff; padding:8px; margin-top:8px; white-space:pre-wrap; max-height:220px; overflow:auto;"></pre>
</div>

<div class="container py-4">
<div id="main-view">
<h1 class="dashboard-title">å®¢æˆ·é¢åº¦æ€»è§ˆ</h1>
<div class="action-bar">
<button class="btn btn-primary" id="addRecordBtn">æ·»åŠ æ¶ˆè´¹è®°å½•</button>
<button class="btn btn-outline-secondary" id="importBtn">å¯¼å…¥æ•°æ®</button>
<button class="btn btn-outline-secondary" id="exportBtn">å¯¼å‡ºæ•°æ®</button>
<input accept=".json" id="importFile" style="display:none;" type="file"/>
</div>
<div class="dashboard" id="dashboard"></div>
</div>
<div id="detail-view" style="display:none;">
<h1 class="dashboard-title" id="detail-title"></h1>
<div class="action-bar">
<button class="btn btn-secondary" id="backToDashboardBtn">è¿”å›æ€»è§ˆ</button>
<button class="btn btn-outline-primary" id="exportClientBtn">å¯¼å‡ºJSON</button>
<button class="btn btn-success" id="exportExcelBtn">å¯¼å‡ºExcel</button>
</div>
<div class="table-responsive">
<table class="table table-striped table-hover align-middle">
<thead class="table-dark">
<tr><th>æ—¥æœŸ</th><th>åˆ†ç±»</th><th>é¡¹ç›®</th><th>ä¾›åº”å•†</th><th>æ•°é‡</th><th>å•ä»·</th><th>æ€»é¢</th><th>å¤‡æ³¨</th><th>æ“ä½œ</th></tr>
</thead>
<tbody id="clientCostTableBody"></tbody>
</table>
</div>
</div>
</div>
<!-- æ¨¡æ€ï¼šæ·»åŠ /ç¼–è¾‘è®°å½• -->
<div class="modal fade" id="recordModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content">
<div class="modal-header"><h5 class="modal-title" id="recordModalTitle">æ·»åŠ è®°å½•</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal" type="button"></button></div>
<div class="modal-body">
<form id="recordForm">
<input id="recordId" type="hidden"/>
<div class="row g-3">
<div class="col-md-6"><label class="form-label">æ—¥æœŸ</label><input class="form-control" id="recordDate" required="" type="date"/></div>
<div class="col-md-6"><label class="form-label">å®¢æˆ·</label><select class="form-select" id="recordClient" required=""></select></div>
<div class="col-md-6"><label class="form-label">åˆ†ç±»</label><select class="form-select" id="recordCategory" required=""></select></div>
<div class="col-md-6"><label class="form-label">é¡¹ç›®</label><input class="form-control" id="recordItemName" placeholder="ä¾‹å¦‚ï¼šç¬¬ä¸€å­£åº¦è¡¥å……å‰‚" required="" type="text"/></div>
<div class="col-md-12"><label class="form-label">ä¾›åº”å•†</label><input class="form-control" id="recordSupplier" type="text"/></div>
<div class="col-md-4"><label class="form-label">æ•°é‡</label><input class="form-control" id="recordQuantity" min="0" required="" type="number" value="1"/></div>
<div class="col-md-4"><label class="form-label">å•ä»·</label><input class="form-control" id="recordUnitPrice" min="0" required="" step="0.01" type="number"/></div>
<div class="col-md-4"><label class="form-label">æ€»é¢</label><input class="form-control" id="recordTotalAmount" min="0" readonly="" required="" step="0.01" type="number"/></div>
<div class="col-md-12"><label class="form-label">å¤‡æ³¨</label><textarea class="form-control" id="recordNotes" rows="2"></textarea></div>
</div>
</form>
</div>
<div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal" type="button">å–æ¶ˆ</button><button class="btn btn-primary" id="saveRecordBtn" type="button">ä¿å­˜</button></div>
</div></div></div>
<!-- æ¨¡æ€ï¼šæ–°å¢å®¢æˆ· -->
<div class="modal fade" id="addClientModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
<div class="modal-header"><h5 class="modal-title">æ–°å¢å®¢æˆ·</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal" type="button"></button></div>
<div class="modal-body">
<div class="mb-3"><label class="form-label">å®¢æˆ·å§“å</label><input class="form-control" id="newClientName" placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰" type="text"/></div>
<div class="mb-3"><label class="form-label">å®¢æˆ·ç±»å‹</label><select class="form-select" id="newClientType"><option value="åŸºç¡€ç‰ˆ">åŸºç¡€ç‰ˆ (é¢åº¦: 40,000)</option><option value="Proç‰ˆ">Proç‰ˆ (é¢åº¦: 120,000)</option><option value="ç‰¹æ®Š">ç‰¹æ®Š(æ‰‹åŠ¨è¾“å…¥é¢åº¦)</option></select></div>
<div class="mb-3" id="manualQuotaWrapper" style="display:none;"><label class="form-label">æ€»é¢åº¦</label><input class="form-control" id="newClientQuota" min="0" placeholder="ä¾‹å¦‚ï¼š150000" type="number"/></div>
</div>
<div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal" type="button">å–æ¶ˆ</button><button class="btn btn-primary" id="saveNewClientBtn" type="button">ä¿å­˜å®¢æˆ·</button></div>
</div></div></div>
<!-- åˆ é™¤ç¡®è®¤ -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
<div class="modal-header"><h5 class="modal-title">ç¡®è®¤åˆ é™¤</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal" type="button"></button></div>
<div class="modal-body"><p>æ‚¨ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚</p></div>
<div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal" type="button">å–æ¶ˆ</button><button class="btn btn-danger" id="confirmDeleteBtn" type="button">ç¡®è®¤åˆ é™¤</button></div>
</div></div></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
/*
  æ³¨æ„ï¼šè¯·åœ¨ä¸‹é¢å¡«å…¥ä½ çš„ Supabase é¡¹ç›®é…ç½®ï¼ˆä¸¤å¤„ï¼‰ï¼š
    1) SUPABASE_URL
    2) SUPABASE_KEY (anon public key)
*/
const SUPABASE_URL = "https://wzoilujmllyrohnbsfgn.supabase.co"; // â† æ›¿æ¢
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6b2lsdWptbGx5cm9obmJzZmduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4MDExODQsImV4cCI6MjA3MDM3NzE4NH0.2hq4am66y1IFQa-7INmOBzoyXlfC7g6lO5ikCdkxi2g"; // â† æ›¿æ¢
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);


// ===== Debug helpers for anonymous insert testing =====
async function debugInsertNoClient() {
  const resultEl = document.getElementById('debug-result');
  resultEl.textContent = 'æ­£åœ¨å°è¯•æ’å…¥ï¼ˆä¸å« client_idï¼‰...';
  try {
    const insertData = {
      date: new Date().toISOString().split('T')[0],
      category: 'debugæµ‹è¯•',
      item_name: 'åŒ¿åæµ‹è¯•é¡¹ç›®',
      supplier: 'è°ƒè¯•',
      quantity: 1,
      unit_price: 1,
      total_amount: 1,
      notes: 'åŒ¿åæ’å…¥(ä¸å«client_id)',
      created_at: new Date().toISOString()
    };
    const { data, error } = await supabaseClient.from('cost_records').insert([insertData]).select();
    if (error) resultEl.textContent = 'âŒ æ’å…¥å¤±è´¥: ' + JSON.stringify(error, null, 2);
    else resultEl.textContent = 'âœ… æ’å…¥æˆåŠŸ: ' + JSON.stringify(data, null, 2);
  } catch (err) {
    resultEl.textContent = 'âŒ JSå¼‚å¸¸: ' + err.message;
  }
}

async function debugInsertClientAndRecord() {
  const resultEl = document.getElementById('debug-result');
  resultEl.textContent = 'æ­£åœ¨æ’å…¥å®¢æˆ·å¹¶è®°å½•...';
  try {
    const newClient = { name: 'DEBUG å®¢æˆ· ' + Date.now(), type: 'æµ‹è¯•', quota: 0, start_date: new Date().toISOString().slice(0,10) };
    const { data: cdata, error: cerr } = await supabaseClient.from('clients').insert([newClient]).select().single();
    if (cerr) { resultEl.textContent = 'âŒ æ’å…¥å®¢æˆ·å¤±è´¥: ' + JSON.stringify(cerr, null, 2); return; }
    const record = { client_id: cdata.id, date: new Date().toISOString().split('T')[0], category: 'debug', item_name: 'æ’å…¥è®°å½•', supplier: 'è°ƒè¯•', quantity: 1, unit_price: 1, total_amount: 1, notes: 'æ¥è‡ªdebug' };
    const { data: rdata, error: rerr } = await supabaseClient.from('cost_records').insert([record]).select().single();
    if (rerr) { resultEl.textContent = 'âŒ æ’å…¥è®°å½•å¤±è´¥: ' + JSON.stringify(rerr, null, 2); return; }
    resultEl.textContent = 'âœ… æˆåŠŸ: å®¢æˆ· id=' + cdata.id + ' è®°å½• id=' + rdata.id;
  } catch (err) {
    resultEl.textContent = 'âŒ JSå¼‚å¸¸: ' + err.message;
  }
}

async function debugClearTestRecords() {
  const resultEl = document.getElementById('debug-result');
  resultEl.textContent = 'æ­£åœ¨åˆ é™¤ cost_records ä¸­çš„ debug æ¡ç›®...';
  try {
    // è¿™é‡Œä½¿ç”¨ notes å­—æ®µåŒ…å« "debug" çš„ä½œä¸ºæµ‹è¯•è®°å½•æ ‡è¯†ï¼ˆè°¨æ…ï¼‰
    const { data, error } = await supabaseClient.from('cost_records').delete().like('notes', '%debug%');
    if (error) resultEl.textContent = 'âŒ åˆ é™¤å¤±è´¥: ' + JSON.stringify(error, null, 2);
    else resultEl.textContent = 'âœ… åˆ é™¤æˆåŠŸ: ' + (data ? JSON.stringify(data, null, 2) : 'æ— è¿”å›æ•°æ®');
  } catch (err) {
    resultEl.textContent = 'âŒ JSå¼‚å¸¸: ' + err.message;
  }
}

document.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('debug-insert-btn');
  if (btn) btn.addEventListener('click', debugInsertNoClient);
  const btn2 = document.getElementById('debug-insert-client-btn');
  if (btn2) btn2.addEventListener('click', debugInsertClientAndRecord);
  const btn3 = document.getElementById('debug-clear-btn');
  if (btn3) btn3.addEventListener('click', debugClearTestRecords);
});
// ===== end debug helpers =====


// ===== åˆ†ç±»ç»“æ„ä¸é¢œè‰²ï¼ˆä¿ç•™ä½ åŸæ¥çš„ï¼‰ =====
const CATEGORY_STRUCTURE = {
  "å®ç‰©æˆæœ¬": ["å®šåˆ¶è¡¥å……å‰‚æˆæœ¬", "ç›Šç”ŸèŒæˆæœ¬", "åŒæºæ€§è·å°”è’™æˆæœ¬","ç”Ÿç‰©åŒæºæ€§è·å°”è’™æˆæœ¬"],
  "æ–¹æ¡ˆæˆæœ¬": ["ç¾å›½é•¿å¯¿æ–¹æ¡ˆæˆæœ¬", "åŒ»å…æ–¹æ¡ˆæˆæœ¬", "è†³é£Ÿæ–¹æ¡ˆæˆæœ¬", "æ–¹æ¡ˆç ”å‘/æ›´æ–°æˆæœ¬", "åŒ»ç–—æ–¹æ¡ˆæˆæœ¬"],
  "é¢å¤–é‡‡ä¹°å¥½ç‰©æˆæœ¬": ["é¢å¤–é‡‡ä¹°å¥½ç‰©æˆæœ¬"],
  "å®¢æˆ·æœåŠ¡æˆæœ¬": ["æ‹œè®¿å®¢æˆ·å·®æ—…è´¹", "å®¢æˆ·æ‹›å¾…è´¹", "å…¶ä»–å®¢æˆ·æœåŠ¡è´¹ç”¨", "æ‹œè®¿å®¢æˆ·æˆæœ¬"],
  "æ£€æµ‹æˆæœ¬": ["æ—¶å…‰å°º3.0", "æ—¶å…‰å°º2.0 NAD+", "16Sè‚ é“èŒç¾¤", "å…¶ä»–æ£€æµ‹é¡¹ç›®", "æ£€æµ‹æˆæœ¬", "NAD+"],
  "æŠ—è¡°è®¾å¤‡æˆæœ¬": ["è®¾å¤‡é‡‡è´­æˆæœ¬", "è®¾å¤‡ç»´æŠ¤æˆæœ¬", "æŠ—è¡°è®¾å¤‡ä½¿ç”¨æˆæœ¬"],
  "ææˆ": ["ææˆ", "è½¬åŒ–ææˆ"],
  "å…¶ä»–æˆæœ¬": ["å…¶ä»–æˆæœ¬"]
};
const CATEGORY_COLORS = {
  "å®ç‰©æˆæœ¬": "#ff6384","æ–¹æ¡ˆæˆæœ¬": "#4bc0c0","é¢å¤–é‡‡ä¹°å¥½ç‰©æˆæœ¬": "#ff9f40","å®¢æˆ·æœåŠ¡æˆæœ¬": "#c9cbcf","æ£€æµ‹æˆæœ¬": "#36a2eb","æŠ—è¡°è®¾å¤‡æˆæœ¬": "#9966ff","ææˆ": "#ffce56","å…¶ä»–æˆæœ¬": "#a3a3a3","é»˜è®¤": "#6c757d"
};
const SUB_TO_MAIN_CATEGORY_MAP = {};
for (const m in CATEGORY_STRUCTURE) CATEGORY_STRUCTURE[m].forEach(s=>SUB_TO_MAIN_CATEGORY_MAP[s]=m);
function getMainCategory(sub){ return SUB_TO_MAIN_CATEGORY_MAP[sub]||'å…¶ä»–æˆæœ¬'; }

// ===== æ¨¡æ€å®ä¾‹ =====
const recordModal = new bootstrap.Modal(document.getElementById('recordModal'));
const addClientModal = new bootstrap.Modal(document.getElementById('addClientModal'));
const deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
let recordToDelete = null;

// ===== å…¨å±€æ•°æ®ç¼“å­˜ï¼ˆç”± loadData æ‹‰å–å¹¶èµ‹å€¼ï¼‰ =====
let data = { clients: [], costRecords: [] };

// ===== æµ‹è¯•æ•°æ®ï¼ˆæ¥è‡ªä½ åŸæ–‡ä»¶ï¼Œå·²æŠŠ client ç”¨ name æ ‡è®°ä»¥ä¾¿é¦–æ¬¡æ’å…¥æ—¶åŒ¹é…ï¼‰ =====
function getInitData() {
  return {
    clients: [
      { name: "å½­é»", start_date: "2025-06-09", type: "Proç‰ˆ", quota: 150000 },
      { name: "æ½˜&å¾", start_date: "2025-04-20", type: "Proç‰ˆ", quota: 240000 },
      { name: "ç‹å¨´&ç‹æ°", start_date: "2025-07-01", type: "åŸºç¡€ç‰ˆ", quota: 80000 },
      { name: "æ¢…é¾™æ¯…", start_date: "2025-06-26", type: "åŸºç¡€ç‰ˆ", quota: 40000 },
      { name: "å´è¾¹", start_date: "2024-10-15", type: "åŸºç¡€ç‰ˆ", quota: 40000 }
    ],
    costRecords: [
      { clientName: "å½­é»", date: "2025-07-11", category: "å®šåˆ¶è¡¥å……å‰‚æˆæœ¬", item_name: "ç¬¬ä¸€å­£åº¦å®šåˆ¶è¡¥å……å‰‚", supplier: "è¢åè¿œ", quantity: 1, unit_price: 2400, total_amount: 2400, notes: "æ— " },
      { clientName: "å½­é»", date: "2025-07-11", category: "ç›Šç”ŸèŒæˆæœ¬", item_name: "å…«å‘¨ç›Šç”ŸèŒ", supplier: "é‡‘è£•", quantity: 1, unit_price: 2357, total_amount: 2357, notes: "2347ï¼ŒåŠ ä¸Šé¢„ä¼°10å…ƒå¯„é€è¿è´¹" },
      { clientName: "å½­é»", date: "2025-07-11", category: "æŠ—è¡°è®¾å¤‡ä½¿ç”¨æˆæœ¬", item_name: "æ¯æœˆ10æ¬¡è®¾å¤‡ä½¿ç”¨ï¼ˆä¸€å¹´ï¼‰", supplier: "å¹¿å·æ—¶å…‰æ´¾", quantity: 1, unit_price: 8000, total_amount: 8000, notes: "" },
      { clientName: "å½­é»", date: "2025-07-11", category: "ç”Ÿç‰©åŒæºæ€§è·å°”è’™æˆæœ¬", item_name: "ç¬¬ä¸€æ¬¡è·å°”è’™ä»˜æ¬¾", supplier: "é²åš", quantity: 1, unit_price: 10677, total_amount: 10677, notes: "ç¬¬ä¸€æ¬¡é¢è¯Šï¼‹ç¬¬ä¸€å­£åº¦è¯è´¹ï¼‹å¸®å¸¦è´¹ç”¨" },

      { clientName: "æ½˜&å¾", date: "2025-05-09", category: "æ£€æµ‹æˆæœ¬", item_name: "é—®é¢˜æ’æŸ¥ï¼ˆåŒ…å«å„ç§æ£€æµ‹ï¼‰", supplier: "åæµ‹", quantity: 1, unit_price: 7200, total_amount: 7200, notes: "ä»¥ä¸‹ä»½æ•°*2\nå…¨å¥—æœ‰æœºé…¸ä»£è°¢åˆ†æ\nè¥å…»ä¸æ¯’æ€§å…ƒç´ åˆ†æ\næ··åˆè¿‡æ•æº20é¡¹\nä¸Šå‘¼å¸é“æ„ŸæŸ“EBç—…æ¯’æŠ—ä½“æ£€æµ‹å››é¡¹\nç—…åŸæŠ—ä½“ä¹é¡¹\nå‘¼å¸é“æ ¸é…¸å…­è”æ£€\nè‚ºç‚æ”¯åŸä½“è„±æ°§æ ¸ç³–æ ¸é…¸æ£€æµ‹\nå·¨ç»†èƒç—…æ¯’æŠ—ä½“IgMå®šé‡\nå·¨ç»†èƒç—…æ¯’æŠ—ä½“IgGå®šé‡" },
      { clientName: "æ½˜&å¾", date: "2025-05-28", category: "æ£€æµ‹æˆæœ¬", item_name: "16sè‚ é“èŒç¾¤æ£€æµ‹", supplier: "é‡‘è£•", quantity: 1, unit_price: 1566, total_amount: 1566, notes: "åŒ…å«16sæ£€æµ‹*2ï¼Œå«æ–‡å°è´¹ã€è¿è´¹ã€è€—æ" },
      { clientName: "æ½˜&å¾", date: "2025-04-25", category: "æ£€æµ‹æˆæœ¬", item_name: "æ—¶å…‰å°º3.0", supplier: "åæµ‹ç­‰", quantity: 1, unit_price: 14558, total_amount: 14558, notes: "æˆæœ¬*2" },
      { clientName: "æ½˜&å¾", date: "2025-04-25", category: "æ£€æµ‹æˆæœ¬", item_name: "NAD+", supplier: "éƒå", quantity: 1, unit_price: 450, total_amount: 450, notes: "æ£€æµ‹+ç‰©æµæˆæœ¬ï¼ˆ225*2ï¼‰" },
      { clientName: "å½­é»", date: "2025-06-20", category: "æ£€æµ‹æˆæœ¬", item_name: "16sè‚ é“èŒç¾¤æ£€æµ‹", supplier: "é‡‘è£•", quantity: 1, unit_price: 723, total_amount: 723, notes: "æ— æ–‡å°è´¹å’ŒæŠ¥å‘Šé‚®å¯„è´¹" },
      { clientName: "æ½˜&å¾", date: "2025-01-21", category: "æ‹œè®¿å®¢æˆ·æˆæœ¬", item_name: "ä¸Šé—¨æ‹œè®¿", supplier: "äº¤é€š", quantity: 1, unit_price: 880.09, total_amount: 880.09, notes: "ç«è½¦ç¥¨818å…ƒ+å¾æ–¹å€©æ‰“è½¦62.09å…ƒ" },
      { clientName: "æ½˜&å¾", date: "2025-02-12", category: "é¢å¤–é‡‡ä¹°å¥½ç‰©æˆæœ¬", item_name: "æ¶²ä½“é’™", supplier: "æ·˜å®", quantity: 1, unit_price: 917.5, total_amount: 917.5, notes: "" },
      { clientName: "æ½˜&å¾", date: "2025-01-21", category: "æ‹œè®¿å®¢æˆ·æˆæœ¬", item_name: "ä½ç³–æ°´æœ", supplier: "æ°´æœ", quantity: 1, unit_price: 295.95, total_amount: 295.95, notes: "" },
      { clientName: "æ½˜&å¾", date: "2025-03-15", category: "æ‹œè®¿å®¢æˆ·æˆæœ¬", item_name: "çº¿ä¸‹æ‹›å¾…æœåˆ‡", supplier: "æ°´æœ", quantity: 1, unit_price: 22.8, total_amount: 22.8, notes: "" },
      { clientName: "æ½˜&å¾", date: "2025-06-11", category: "é¢å¤–é‡‡ä¹°å¥½ç‰©æˆæœ¬", item_name: "ç›Šç”ŸèŒå«ç‰‡", supplier: "æ·˜å®", quantity: 1, unit_price: 765, total_amount: 765, notes: "foræ½˜å…ˆç”Ÿå’½ç‚ï¼ˆæ€»å…±ä¹°äº†å¥½å‡ ç›’" },
      { clientName: "æ½˜&å¾", date: "2025-06-05", category: "æ‹œè®¿å®¢æˆ·æˆæœ¬", item_name: "çº¿ä¸‹æ‹œè®¿", supplier: "äº¤é€š", quantity: 1, unit_price: 1098, total_amount: 1098, notes: "äºŒäººå¾€è¿”+æ‰“è½¦" },
      { clientName: "æ½˜&å¾", date: "2025-07-20", category: "å®šåˆ¶è¡¥å……å‰‚æˆæœ¬", item_name: "ç¬¬ä¸€å­£åº¦å®šåˆ¶è¡¥å……å‰‚", supplier: "è¢åè¿œ", quantity: 1, unit_price: 4800, total_amount: 4800, notes: "" },
      { clientName: "æ½˜&å¾", date: "2025-07-11", category: "ç›Šç”ŸèŒæˆæœ¬", item_name: "2ä¸ªæœˆç›Šç”ŸèŒ", supplier: "é‡‘è£•", quantity: 1, unit_price: 3142, total_amount: 3142, notes: "3122+è¿è´¹20" },
      { clientName: "æ½˜&å¾", date: "2025-05-12", category: "æ‹œè®¿å®¢æˆ·æˆæœ¬", item_name: "æ‹œè®¿å®¢æˆ·", supplier: "äº¤é€š", quantity: 1, unit_price: 549.84, total_amount: 549.84, notes: "ä½å®¿99+å¾€è¿”è½¦ç¥¨184+185ï¼Œè¿”ç¨‹æ‰“è½¦çº¦56" },

      { clientName: "ç‹å¨´&ç‹æ°", date: "2025-07-11", category: "åŒ»ç–—æ–¹æ¡ˆæˆæœ¬", item_name: "åŒ»ç–—æ–¹æ¡ˆ", supplier: "å¼ åŒ»ç”Ÿ", quantity: 1, unit_price: 1200, total_amount: 1200, notes: "600*2" },
      { clientName: "ç‹å¨´&ç‹æ°", date: "2025-07-11", category: "å®šåˆ¶è¡¥å……å‰‚æˆæœ¬", item_name: "ç¬¬ä¸€å­£åº¦å®šåˆ¶è¡¥å……å‰‚", supplier: "è¢åè¿œ", quantity: 1, unit_price: 4800, total_amount: 4800, notes: "" },

      { clientName: "æ¢…é¾™æ¯…", date: "2025-07-11", category: "å®šåˆ¶è¡¥å……å‰‚æˆæœ¬", item_name: "ç¬¬ä¸€å­£åº¦å®šåˆ¶è¡¥å……å‰‚", supplier: "è¢åè¿œ", quantity: 1, unit_price: 2400, total_amount: 2400, notes: "" },
      { clientName: "æ¢…é¾™æ¯…", date: "2025-07-11", category: "åŒ»ç–—æ–¹æ¡ˆæˆæœ¬", item_name: "åˆæ¬¡åŒ»ç–—æ–¹æ¡ˆ", supplier: "å¼ åŒ»ç”Ÿ", quantity: 1, unit_price: 300, total_amount: 300, notes: "" },
      { clientName: "æ¢…é¾™æ¯…", date: "2025-07-11", category: "åŒ»ç–—æ–¹æ¡ˆæˆæœ¬", item_name: "3.0è§£è¯»", supplier: "é²åš", quantity: 1, unit_price: 1500, total_amount: 1500, notes: "" },
      { clientName: "æ¢…é¾™æ¯…", date: "2025-07-11", category: "åŒ»ç–—æ–¹æ¡ˆæˆæœ¬", item_name: "è½¬åŒ–ææˆ", supplier: "é²åš", quantity: 1, unit_price: 600, total_amount: 600, notes: "" },
      { clientName: "æ¢…é¾™æ¯…", date: "2025-07-11", category: "åŒ»ç–—æ–¹æ¡ˆæˆæœ¬", item_name: "è½¬åŒ–ææˆ", supplier: "é²åš", quantity: 1, unit_price: 600, total_amount: 600, notes: "" },

      { clientName: "å´è¾¹", date: "2025-07-11", category: "å®šåˆ¶è¡¥å……å‰‚æˆæœ¬", item_name: "ä¸‰ä¸ªå­£åº¦å®šåˆ¶è¡¥å……å‰‚", supplier: "è¢åè¿œ", quantity: 1, unit_price: 7200, total_amount: 7200, notes: "" },
      { clientName: "å´è¾¹", date: "2025-06-26", category: "åŒ»ç–—æ–¹æ¡ˆæˆæœ¬", item_name: "çº¿ä¸Šå›è®¿", supplier: "å¼ åŒ»ç”Ÿ", quantity: 1, unit_price: 426.67, total_amount: 426.67, notes: "32min" }
    ]
  };
}

// ===== åˆå§‹åŒ–ï¼šå¦‚æœæ•°æ®åº“ä¸ºç©ºåˆ™å¯¼å…¥æµ‹è¯•æ•°æ®ï¼ˆå¹¶ä¿è¯ client->record æ­£ç¡®å…³è”ï¼‰ =====
async function initDatabaseIfEmpty() {
  try {
    const { data: clients, error: cErr } = await supabaseClient.from('clients').select('id').limit(1);
    if (cErr) { console.error(cErr); return; }
    if (!clients || clients.length === 0) {
      const init = getInitData();
      // æ’å…¥ clients
      const { error: insertClientsErr } = await supabaseClient.from('clients').insert(init.clients);
      if (insertClientsErr) { console.error(insertClientsErr); return; }
      // è¯»å–æ’å…¥åçš„ clientsï¼Œç”¨ name->id æ˜ å°„
      const { data: insertedClients } = await supabaseClient.from('clients').select('*');
      const nameToId = {};
      insertedClients.forEach(c => nameToId[c.name] = c.id);
      // æ„é€  cost_recordsï¼ˆæ›¿æ¢ clientName -> client_idï¼‰
      const recordsToInsert = init.costRecords.map(r => ({
        client_id: nameToId[r.clientName],
        date: r.date,
        category: r.category,
        item_name: r.item_name,
        supplier: r.supplier,
        quantity: r.quantity,
        unit_price: r.unit_price,
        total_amount: r.total_amount,
        notes: r.notes
      }));
      const { error: insertRecordsErr } = await supabaseClient.from('cost_records').insert(recordsToInsert);
      if (insertRecordsErr) console.error(insertRecordsErr);
    }
  } catch (err) {
    console.error('initDatabaseIfEmpty error', err);
  }
}

// ===== ä» Supabase æ‹‰å–æ•°æ®å¹¶æ›´æ–°å…¨å±€ data =====
async function loadData() {
  try {
    const { data: clients, error: cErr } = await supabaseClient.from('clients').select('*').order('id', { ascending: true });
    if (cErr) console.error(cErr);
    const { data: costRecords, error: rErr } = await supabaseClient.from('cost_records').select('*').order('date', { ascending: false });
    if (rErr) console.error(rErr);
    data.clients = clients || [];
    data.costRecords = costRecords || [];
  } catch (err) {
    console.error('loadData error', err);
  }
}

// ===== æ¸²æŸ“é€»è¾‘ï¼ˆåŸºæœ¬æ²¿ç”¨ä½ åŸæ¥çš„ç•Œé¢å®ç°ï¼Œå­—æ®µåè°ƒæ•´ä»¥åŒ¹é… DBï¼‰ =====
function getClient(clientId) { return data.clients.find(c => c.id == clientId); }
function getClientQuota(client) {
  if (!client) return 0;
  if (client.quota) return Number(client.quota);
  if (client.name === 'æ½˜&å¾') return 240000;
  if (client.name === 'å½­é»') return 150000;
  if (client.type && client.type.includes('Pro')) return 120000;
  return 40000;
}
const getClientSpent = (clientId) => data.costRecords.filter(r => r.client_id == clientId).reduce((s, r) => s + Number(r.total_amount), 0);
function getQuotaColor(spent, quota) {
  const percent = quota > 0 ? spent / quota : 0;
  if (percent >= 1) return '#e74c3c';
  if (percent >= 0.6) return '#f7b731';
  return '#2e7be6';
}

function renderAll() { renderDashboard(); }

function renderDashboard() {
  const dashboard = document.getElementById('dashboard');
  dashboard.innerHTML = '';
  data.clients.forEach(client => {
    const card = document.createElement('div');
    card.className = 'client-card';
    const quota = getClientQuota(client);
    const spent = getClientSpent(client.id);
    const remaining = quota - spent;
    const spentPercent = quota > 0 ? (spent / quota) * 100 : 0;
    const barColor = getQuotaColor(spent, quota);
    const spentRatio = quota > 0 ? spent / quota : 0;
    let alertBadge = '';
    if (spentRatio >= 1) alertBadge = '<span class="danger-badge">è¶…é¢</span>';
    else if (spentRatio >= 0.6) alertBadge = '<span class="warning-badge">è¶…60%</span>';

    card.innerHTML = `
      <div class="client-name" data-client-id="${client.id}">${client.name} ${alertBadge}</div>
      <div class="info-row">æ€»é¢åº¦: <b>ï¿¥${getClientQuota(client).toLocaleString()}</b></div>
      <div class="info-row">å·²èŠ±è´¹: <b style="color: ${barColor};">ï¿¥${spent.toLocaleString()}</b></div>
      <div class="info-row">å‰©ã€€ä½™: <b style="color: #28a745;">ï¿¥${remaining.toLocaleString()}</b></div>
      <div class="client-pie"><canvas id="pie_${client.id}"></canvas></div>
      <div class="pie-label-container" id="pie_labels_${client.id}"></div>
      <div class="quota-bar-wrapper">
        <div class="quota-bar-bg">
          <div class="quota-bar-fill" style="background:${barColor}; width:${Math.min(100, spentPercent).toFixed(2)}%;"></div>
          <div class="quota-bar-text">${spentPercent.toFixed(1)}% å·²ç”¨</div>
        </div>
      </div>
    `;
    dashboard.appendChild(card);
    // render pie after element attached
    setTimeout(()=> renderPieChart(client), 0);
  });

  const addCard = document.createElement('div');
  addCard.className = 'add-client-card';
  addCard.innerHTML = '+';
  addCard.onclick = () => addClientModal.show();
  dashboard.appendChild(addCard);
}

function renderPieChart(client) {
  const ctx = document.getElementById(`pie_${client.id}`);
  if (!ctx) return;
  const records = data.costRecords.filter(r => r.client_id == client.id);
  const mainCategoryMap = new Map();
  records.forEach(r => {
    const mainCat = getMainCategory(r.category);
    const currentTotal = mainCategoryMap.get(mainCat) || 0;
    mainCategoryMap.set(mainCat, currentTotal + Number(r.total_amount));
  });
  const labels = [...mainCategoryMap.keys()];
  const values = [...mainCategoryMap.values()];
  if (labels.length === 0) {
    ctx.parentElement.innerHTML = '<div style="color:#999;text-align:center;margin-top:70px;">æš‚æ— æ¶ˆè´¹è®°å½•</div>';
    document.getElementById(`pie_labels_${client.id}`).innerHTML = '';
    return;
  }
  if (window[`pieChart_${client.id}`]) window[`pieChart_${client.id}`].destroy();
  window[`pieChart_${client.id}`] = new Chart(ctx, {
    type: 'doughnut',
    data: { labels, datasets: [{ data: values, backgroundColor: labels.map(l => CATEGORY_COLORS[l] || CATEGORY_COLORS['é»˜è®¤']), borderColor:'#fff', borderWidth:3 }]},
    options: { responsive:true, maintainAspectRatio:false, plugins: { legend:{display:false}, datalabels:{ display: (ctx)=> { const total = ctx.chart.getDatasetMeta(0).total; return (ctx.dataset.data[ctx.dataIndex] / total) > 0.05; }, color:'#fff', font:{weight:'bold', size:12}, formatter:(v,c)=> { const total = c.chart.getDatasetMeta(0).total; return (v/total*100).toFixed(0) + '%'; }, textStrokeColor:'#333', textStrokeWidth:2 } }, cutout: '60%' }, plugins:[ChartDataLabels]
  });
  const labelContainer = document.getElementById(`pie_labels_${client.id}`);
  labelContainer.innerHTML = labels.map(l => `<span class="pie-label" style="background-color:${CATEGORY_COLORS[l] || CATEGORY_COLORS['é»˜è®¤']}">${l}</span>`).join('');
}

function showClientDetail(clientId) {
  const client = getClient(clientId);
  if (!client) return;
  document.getElementById('main-view').style.display = 'none';
  document.getElementById('detail-view').style.display = 'block';
  document.getElementById('detail-title').textContent = `${client.name} - æ¶ˆè´¹æ˜ç»†`;
  document.getElementById('exportClientBtn').onclick = () => exportClientData(clientId);
  document.getElementById('exportExcelBtn').onclick = () => exportClientDataAsExcel(clientId);
  renderClientCostTable(clientId);
}
function hideClientDetail() { document.getElementById('main-view').style.display='block'; document.getElementById('detail-view').style.display='none'; renderAll(); }

function renderClientCostTable(clientId) {
  const tbody = document.getElementById('clientCostTableBody');
  tbody.innerHTML = '';
  const records = data.costRecords.filter(r => r.client_id == clientId);
  if (records.length === 0) { tbody.innerHTML = `<tr><td colspan="9" class="text-center p-4">æš‚æ— è®°å½•</td></tr>`; return; }
  records.sort((a,b)=> new Date(b.date)-new Date(a.date)).forEach(record => tbody.appendChild(createRecordRow(record)));
}
function createRecordRow(record) {
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>${record.date}</td>
    <td>${record.category}</td>
    <td>${record.item_name}</td>
    <td>${record.supplier || ''}</td>
    <td>${record.quantity}</td>
    <td>ï¿¥${Number(record.unit_price).toLocaleString()}</td>
    <td>ï¿¥${Number(record.total_amount).toLocaleString()}</td>
    <td>${record.notes || ''}</td>
    <td class="table-actions">
      <button class="btn btn-sm btn-outline-primary edit-btn" data-id="${record.id}">ç¼–è¾‘</button>
      <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${record.id}">åˆ é™¤</button>
    </td>`;
  return tr;
}

// ===== äº‹ä»¶ç»‘å®š =====
document.getElementById('backToDashboardBtn').onclick = hideClientDetail;
document.getElementById('dashboard').addEventListener('click', e => {
  const cn = e.target.closest('.client-name');
  if (cn) showClientDetail(cn.dataset.clientId);
});

document.getElementById('addRecordBtn').onclick = async () => {
  await updateClientOptions();
  updateCategoryOptions();
  document.getElementById('recordForm').reset();
  document.getElementById('recordId').value = '';
  document.getElementById('recordModalTitle').textContent = 'æ·»åŠ è®°å½•';
  document.getElementById('recordDate').valueAsDate = new Date();
  recordModal.show();
};

const quantityInput = document.getElementById('recordQuantity');
const unitPriceInput = document.getElementById('recordUnitPrice');
quantityInput.addEventListener('input', updateRecordTotal);
unitPriceInput.addEventListener('input', updateRecordTotal);
function updateRecordTotal(){ const q = parseFloat(quantityInput.value)||0; const p = parseFloat(unitPriceInput.value)||0; document.getElementById('recordTotalAmount').value = (q*p).toFixed(2); }

// ===== Supabase CRUD æ“ä½œï¼ˆæ¯æ¬¡æ“ä½œåæˆ‘ä»¬é‡æ–° loadData() å¹¶ renderAll() ä»¥ä¿è¯ç«‹å³åˆ·æ–°ï¼‰ =====
async function insertClient(clientObj) {
  const { data: newClient, error } = await supabaseClient.from('clients').insert([clientObj]).select().single();
  if (error) throw error;
  return newClient;
}
async function insertRecord(recordObj) {
  const { data: newRecord, error } = await supabaseClient.from('cost_records').insert([recordObj]).select().single();
  if (error) throw error;
  return newRecord;
}
async function updateRecord(id, updates) {
  const { data: updated, error } = await supabaseClient.from('cost_records').update(updates).eq('id', id).select().single();
  if (error) throw error;
  return updated;
}
async function deleteRecord(id) {
  const { error } = await supabaseClient.from('cost_records').delete().eq('id', id);
  if (error) throw error;
}

// ===== ä¿å­˜è®°å½•ï¼ˆæ·»åŠ /ç¼–è¾‘ï¼‰æŒ‰é’® =====
document.getElementById('saveRecordBtn').onclick = async () => {
  const form = document.getElementById('recordForm');
  if (!form.checkValidity()) { form.reportValidity(); return; }
  const id = document.getElementById('recordId').value;
  const recordData = {
    client_id: Number(document.getElementById('recordClient').value),
    date: document.getElementById('recordDate').value,
    category: document.getElementById('recordCategory').value,
    item_name: document.getElementById('recordItemName').value.trim(),
    supplier: document.getElementById('recordSupplier').value.trim(),
    quantity: Number(document.getElementById('recordQuantity').value),
    unit_price: Number(document.getElementById('recordUnitPrice').value),
    total_amount: Number(document.getElementById('recordTotalAmount').value),
    notes: document.getElementById('recordNotes').value.trim()
  };
  try {
    if (id) {
      await updateRecord(Number(id), recordData);
    } else {
      await insertRecord(recordData);
    }
    await loadData(); renderAll();
    if (document.getElementById('detail-view').style.display === 'block') renderClientCostTable(recordData.client_id);
    recordModal.hide();
  } catch (err) { console.error(err); alert('ä¿å­˜å¤±è´¥ï¼š' + err.message); }
};

// ç¼–è¾‘ / åˆ é™¤ æŒ‰é’®å¤„ç†ï¼ˆç”±äº‹ä»¶ä»£ç†ï¼‰
document.body.addEventListener('click', async e => {
  if (e.target.classList.contains('edit-btn')) {
    const id = e.target.dataset.id;
    const rec = data.costRecords.find(r => r.id == id);
    if (!rec) return;
    await updateClientOptions();
    updateCategoryOptions();
    document.getElementById('recordId').value = rec.id;
    document.getElementById('recordDate').value = rec.date;
    document.getElementById('recordClient').value = rec.client_id;
    document.getElementById('recordCategory').value = rec.category;
    document.getElementById('recordItemName').value = rec.item_name;
    document.getElementById('recordSupplier').value = rec.supplier;
    document.getElementById('recordQuantity').value = rec.quantity;
    document.getElementById('recordUnitPrice').value = rec.unit_price;
    document.getElementById('recordTotalAmount').value = rec.total_amount;
    document.getElementById('recordNotes').value = rec.notes;
    document.getElementById('recordModalTitle').textContent = 'ç¼–è¾‘è®°å½•';
    recordModal.show();
  }
  if (e.target.classList.contains('delete-btn')) {
    recordToDelete = e.target.dataset.id;
    deleteConfirmModal.show();
  }
});

document.getElementById('confirmDeleteBtn').onclick = async () => {
  if (!recordToDelete) { deleteConfirmModal.hide(); return; }
  try {
    const rec = data.costRecords.find(r => r.id == recordToDelete);
    await deleteRecord(Number(recordToDelete));
    await loadData(); renderAll();
    if (rec) renderClientCostTable(rec.client_id);
    recordToDelete = null;
    deleteConfirmModal.hide();
  } catch (err) { console.error(err); alert('åˆ é™¤å¤±è´¥ï¼š' + err.message); deleteConfirmModal.hide(); }
};

// ===== æ–°å¢å®¢æˆ· UI é€»è¾‘ =====
document.getElementById('newClientType').addEventListener('change', e => {
  document.getElementById('manualQuotaWrapper').style.display = e.target.value === 'ç‰¹æ®Š' ? 'block' : 'none';
});
document.getElementById('saveNewClientBtn').onclick = async () => {
  const name = document.getElementById('newClientName').value.trim();
  const type = document.getElementById('newClientType').value;
  let quota = null;
  if (type === 'ç‰¹æ®Š') {
    quota = parseFloat(document.getElementById('newClientQuota').value);
    if (isNaN(quota) || quota <= 0) { alert('è¯·ä¸ºç‰¹æ®Šç±»å‹å®¢æˆ·å¡«å†™æœ‰æ•ˆçš„é¢åº¦ï¼'); return; }
  }
  if (!name) { alert('è¯·å¡«å†™å®¢æˆ·å§“åï¼'); return; }
  const newClient = { name, type };
  if (quota) newClient.quota = quota;
  try {
    await insertClient(newClient);
    await loadData(); renderAll();
    addClientModal.hide();
    document.getElementById('newClientName').value = '';
    document.getElementById('newClientQuota').value = '';
    document.getElementById('manualQuotaWrapper').style.display = 'none';
  } catch (err) { console.error(err); alert('æ·»åŠ å®¢æˆ·å¤±è´¥ï¼š' + err.message); }
};

// ===== æ›´æ–°å®¢æˆ·é€‰é¡¹ä¸‹æ‹‰ï¼ˆè°ƒç”¨æ—¶ç¡®ä¿ data.clients å·²åŠ è½½ï¼‰ =====
async function updateClientOptions() {
  const sel = document.getElementById('recordClient');
  const currentVal = sel.value;
  sel.innerHTML = '';
  data.clients.forEach(c => {
    const opt = document.createElement('option'); opt.value = c.id; opt.textContent = c.name; sel.appendChild(opt);
  });
  sel.value = currentVal || (data.clients[0] ? data.clients[0].id : '');
}
function updateCategoryOptions() {
  const sel = document.getElementById('recordCategory'); sel.innerHTML = '';
  for (const mainCat in CATEGORY_STRUCTURE) {
    const optGroup = document.createElement('optgroup'); optGroup.label = mainCat;
    CATEGORY_STRUCTURE[mainCat].forEach(sub => { const opt = document.createElement('option'); opt.value = sub; opt.textContent = sub; optGroup.appendChild(opt); });
    sel.appendChild(optGroup);
  }
}

// ===== å¯¼å…¥/å¯¼å‡ºï¼ˆå¯¼å‡º JSON/Excel ä¸å¯¼å…¥ JSONï¼‰ =====
document.getElementById('importBtn').onclick = () => document.getElementById('importFile').click();
document.getElementById('exportBtn').onclick = () => exportData({ clients: data.clients, costRecords: data.costRecords }, 'TimeCure_æ•°æ®å¤‡ä»½');

function exportData(exportObj, baseFileName) {
  const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url;
  a.download = `${baseFileName}_${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
}

function exportClientData(clientId) {
  const client = getClient(clientId);
  const clientRecords = data.costRecords.filter(r => r.client_id == clientId);
  const exportObj = { clients: [client], costRecords: clientRecords };
  exportData(exportObj, `TimeCure_${client.name}_æ˜ç»†`);
}

function exportClientDataAsExcel(clientId) {
  const client = getClient(clientId);
  const records = data.costRecords.filter(r => r.client_id == clientId).sort((a,b)=> new Date(b.date)-new Date(a.date));
  if (!client || records.length === 0) { alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®ã€‚'); return; }
  const headers = ['æ—¥æœŸ','åˆ†ç±»','é¡¹ç›®','ä¾›åº”å•†','æ•°é‡','å•ä»·','æ€»é¢','å¤‡æ³¨'];
  const dataForSheet = records.map(r => [r.date, r.category, r.item_name, r.supplier || '', r.quantity, r.unit_price, r.total_amount, r.notes || '']);
  const totalSpent = records.reduce((s,r)=>s + Number(r.total_amount),0);
  dataForSheet.push([]); dataForSheet.push(['','','','','','æ€»è®¡', totalSpent, '']);
  const ws = XLSX.utils.aoa_to_sheet([headers, ...dataForSheet]);
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'æ¶ˆè´¹æ˜ç»†');
  const fileName = `TimeCure_${client.name}_æ˜ç»†_${new Date().toISOString().slice(0,10)}.xlsx`;
  XLSX.writeFile(wb, fileName);
}

// å¯¼å…¥ JSONï¼ˆä¼šç›´æ¥è¦†ç›–æ•°æ®åº“ï¼šå…ˆæ¸…ç©ºåæ’å…¥ï¼‰
// **æç¤º**ï¼šæ­¤å¤„ä¸ºè¦†ç›–å¼å¯¼å…¥ï¼Œè°¨æ…ä½¿ç”¨
document.getElementById('importFile').onchange = async (e) => {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = async (ev) => {
    try {
      const imported = JSON.parse(ev.target.result);
      if (!Array.isArray(imported.clients) || !Array.isArray(imported.costRecords)) throw new Error('æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œéœ€åŒ…å« clients ä¸ costRecords æ•°ç»„ã€‚');
      // æ¸…ç©ºè¡¨ï¼ˆè°¨æ…ï¼‰
      await supabaseClient.from('cost_records').delete().neq('id', 0);
      await supabaseClient.from('clients').delete().neq('id', 0);
      // æ’å…¥ clients
      await supabaseClient.from('clients').insert(imported.clients);
      const { data: newClients } = await supabaseClient.from('clients').select('*');
      const nameToId = {}; newClients.forEach(c=> nameToId[c.name]=c.id);
      // æ›¿æ¢ client_id å¹¶æ’å…¥ cost_records
      const recs = imported.costRecords.map(r=>{
        return { client_id: nameToId[r.clientName] || r.client_id || null, date:r.date, category:r.category || r.itemName || r.item_name, item_name: r.item_name || r.itemName || r.itemName, supplier:r.supplier || '', quantity:r.quantity||0, unit_price:r.unit_price||r.unitPrice||0, total_amount:r.total_amount||r.totalAmount||0, notes:r.notes||r.note||'' };
      }).filter(r => r.client_id);
      await supabaseClient.from('cost_records').insert(recs);
      await loadData(); renderAll();
      alert('å¯¼å…¥æˆåŠŸï¼ˆå·²è¦†ç›–æ•°æ®åº“ï¼‰');
    } catch (err) { alert('å¯¼å…¥å¤±è´¥ï¼š' + err.message); }
  };
  reader.readAsText(file); e.target.value = '';
};

// ===== é¡µé¢åˆå§‹åŒ–æµç¨‹ =====
(async () => {
  // 1) è‹¥ tables ç©ºåˆ™å¯¼å…¥æµ‹è¯•æ•°æ®ï¼ˆç¬¬ä¸€æ¬¡è®¿é—®ï¼‰
  await initDatabaseIfEmpty();
  // 2) load data & render
  await loadData();
  renderAll();
})();


async function checkConnection() {
  const statusEl = document.getElementById("connection-status");
  try {
    const { data, error } = await supabaseClient.from("clients").select("id").limit(1);
    if (error) {
      statusEl.textContent = "âŒ è¿æ¥å¤±è´¥: " + error.message;
      statusEl.style.background = "#f8d7da";
      statusEl.style.color = "#721c24";
    } else {
      statusEl.textContent = "âœ… å·²è¿æ¥ Supabase";
      statusEl.style.background = "#d4edda";
      statusEl.style.color = "#155724";
    }
  } catch (err) {
    statusEl.textContent = "âŒ è¿æ¥é”™è¯¯: " + err.message;
    statusEl.style.background = "#f8d7da";
    statusEl.style.color = "#721c24";
  }
}
checkConnection();
</script>
</body>
</html>
