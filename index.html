<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TimeCure 财务额度看板（Supabase 版）</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

  <!-- SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { background: #f0f2f5; color:#333; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
    .container { max-width: 1600px; }
    .dashboard { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px; margin: 25px 0; }
    .client-card, .add-client-card { background:#fff; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.07); padding:25px; display:flex; flex-direction:column; align-items:center; position:relative; transition:all .3s ease; border:1px solid #e8e8e8; }
    .client-card:hover, .add-client-card:hover { box-shadow:0 8px 32px rgba(0,0,0,0.12); transform:translateY(-5px); }
    .add-client-card { justify-content:center; font-size:70px; color:#a0a0a0; cursor:pointer; border:2.5px dashed #d9d9d9; background:#fafafa; min-height:450px; }
    .add-client-card:hover { color:#0d6efd; border-color:#0d6efd; background:#f0f8ff; }
    .client-pie { width:180px; height:180px; margin:20px 0; }
    .pie-label-container { width:100%; text-align:center; margin-top:10px; min-height:50px; }
    .pie-label { display:inline-block; font-size:13px; margin:0 8px 5px 0; padding:3px 8px; border-radius:12px; font-weight:500; color:#fff; }
    .client-name { font-size:1.8rem; font-weight:700; color:#1a2747; margin-bottom:1rem; cursor:pointer; display:flex; align-items:center; gap:8px; }
    .info-row { font-size:1rem; color:#555; margin-bottom:.5rem;}
    .info-row b { color:#000; font-weight:600; }
    .quota-bar-wrapper { width:100%; height:25px; margin-top:15px; position:relative; }
    .quota-bar-bg { width:100%; height:100%; background:#e9ecef; border-radius:8px; position:relative; overflow:hidden; }
    .quota-bar-fill { height:100%; border-radius:8px; transition:width .6s ease-in-out; position:absolute; left:0; top:0; }
    .quota-bar-text { position:absolute; width:100%; text-align:center; top:50%; transform:translateY(-50%); color:#fff; font-size:14px; font-weight:bold; text-shadow:1px 1px 2px rgba(0,0,0,.5); }
    .warning-badge, .danger-badge { font-size:.8rem; padding:.2em .6em; border-radius:.8em; color:#fff; font-weight:600; }
    .warning-badge { background-color:#f7b731; }
    .danger-badge { background-color:#e74c3c; }
    .dashboard-title { font-size:2rem; font-weight:700; color:#1a2747; margin-bottom:1rem; }
    .action-bar { margin-bottom:1.5rem; display:flex; gap:1rem; align-items:center; }
    .modal-header { background:#1a2747; color:#fff; }
    .btn-close-white { filter: invert(1) grayscale(100%) brightness(200%); }
  </style>
</head>
<body>
<div class="container py-4">
  <div id="main-view">
    <h1 class="dashboard-title">客户额度总览</h1>
    <div class="action-bar">
      <button class="btn btn-primary" id="addRecordBtn">添加消费记录</button>
      <button class="btn btn-outline-secondary" id="importBtn">导入数据</button>
      <button class="btn btn-outline-secondary" id="exportBtn">导出数据</button>
      <input type="file" id="importFile" accept=".json" style="display:none;">
    </div>
    <div class="dashboard" id="dashboard"></div>
  </div>

  <div id="detail-view" style="display:none;">
    <h1 id="detail-title" class="dashboard-title"></h1>
    <div class="action-bar">
      <button class="btn btn-secondary" id="backToDashboardBtn">返回总览</button>
      <button class="btn btn-outline-primary" id="exportClientBtn">导出JSON</button>
      <button class="btn btn-success" id="exportExcelBtn">导出Excel</button>
    </div>
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle">
        <thead class="table-dark">
          <tr><th>日期</th><th>分类</th><th>项目</th><th>供应商</th><th>数量</th><th>单价</th><th>总额</th><th>备注</th><th>操作</th></tr>
        </thead>
        <tbody id="clientCostTableBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- 模态：添加/编辑记录 -->
<div class="modal fade" id="recordModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content">
  <div class="modal-header"><h5 class="modal-title" id="recordModalTitle">添加记录</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
  <div class="modal-body">
    <form id="recordForm">
      <input type="hidden" id="recordId">
      <div class="row g-3">
        <div class="col-md-6"><label class="form-label">日期</label><input type="date" class="form-control" id="recordDate" required></div>
        <div class="col-md-6"><label class="form-label">客户</label><select class="form-select" id="recordClient" required></select></div>
        <div class="col-md-6"><label class="form-label">分类</label><select class="form-select" id="recordCategory" required></select></div>
        <div class="col-md-6"><label class="form-label">项目</label><input type="text" class="form-control" id="recordItemName" placeholder="例如：第一季度补充剂" required></div>
        <div class="col-md-12"><label class="form-label">供应商</label><input type="text" class="form-control" id="recordSupplier"></div>
        <div class="col-md-4"><label class="form-label">数量</label><input type="number" class="form-control" id="recordQuantity" min="0" value="1" required></div>
        <div class="col-md-4"><label class="form-label">单价</label><input type="number" class="form-control" id="recordUnitPrice" min="0" step="0.01" required></div>
        <div class="col-md-4"><label class="form-label">总额</label><input type="number" class="form-control" id="recordTotalAmount" min="0" step="0.01" required readonly></div>
        <div class="col-md-12"><label class="form-label">备注</label><textarea class="form-control" id="recordNotes" rows="2"></textarea></div>
      </div>
    </form>
  </div>
  <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button><button type="button" class="btn btn-primary" id="saveRecordBtn">保存</button></div>
</div></div></div>

<!-- 模态：新增客户 -->
<div class="modal fade" id="addClientModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
  <div class="modal-header"><h5 class="modal-title">新增客户</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
  <div class="modal-body">
    <div class="mb-3"><label class="form-label">客户姓名</label><input type="text" class="form-control" id="newClientName" placeholder="例如：张三"></div>
    <div class="mb-3"><label class="form-label">客户类型</label><select class="form-select" id="newClientType"><option value="基础版">基础版 (额度: 40,000)</option><option value="Pro版">Pro版 (额度: 120,000)</option><option value="特殊">特殊(手动输入额度)</option></select></div>
    <div class="mb-3" id="manualQuotaWrapper" style="display:none;"><label class="form-label">总额度</label><input type="number" class="form-control" id="newClientQuota" min="0" placeholder="例如：150000"></div>
  </div>
  <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button><button type="button" class="btn btn-primary" id="saveNewClientBtn">保存客户</button></div>
</div></div></div>

<!-- 删除确认 -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
  <div class="modal-header"><h5 class="modal-title">确认删除</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
  <div class="modal-body"><p>您确定要删除这条记录吗？此操作不可撤销。</p></div>
  <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button><button type="button" class="btn btn-danger" id="confirmDeleteBtn">确认删除</button></div>
</div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/*
  注意：请在下面填入你的 Supabase 项目配置（两处）：
    1) SUPABASE_URL
    2) SUPABASE_KEY (anon public key)
*/
const SUPABASE_URL = "https://wzoilujmllyrohnbsfgn.supabase.co"; // ← 替换
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6b2lsdWptbGx5cm9obmJzZmduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4MDExODQsImV4cCI6MjA3MDM3NzE4NH0.2hq4am66y1IFQa-7INmOBzoyXlfC7g6lO5ikCdkxi2g"; // ← 替换
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ===== 分类结构与颜色（保留你原来的） =====
const CATEGORY_STRUCTURE = {
  "实物成本": ["定制补充剂成本", "益生菌成本", "同源性荷尔蒙成本","生物同源性荷尔蒙成本"],
  "方案成本": ["美国长寿方案成本", "医厅方案成本", "膳食方案成本", "方案研发/更新成本", "医疗方案成本"],
  "额外采买好物成本": ["额外采买好物成本"],
  "客户服务成本": ["拜访客户差旅费", "客户招待费", "其他客户服务费用", "拜访客户成本"],
  "检测成本": ["时光尺3.0", "时光尺2.0 NAD+", "16S肠道菌群", "其他检测项目", "检测成本", "NAD+"],
  "抗衰设备成本": ["设备采购成本", "设备维护成本", "抗衰设备使用成本"],
  "提成": ["提成", "转化提成"],
  "其他成本": ["其他成本"]
};
const CATEGORY_COLORS = {
  "实物成本": "#ff6384","方案成本": "#4bc0c0","额外采买好物成本": "#ff9f40","客户服务成本": "#c9cbcf","检测成本": "#36a2eb","抗衰设备成本": "#9966ff","提成": "#ffce56","其他成本": "#a3a3a3","默认": "#6c757d"
};
const SUB_TO_MAIN_CATEGORY_MAP = {};
for (const m in CATEGORY_STRUCTURE) CATEGORY_STRUCTURE[m].forEach(s=>SUB_TO_MAIN_CATEGORY_MAP[s]=m);
function getMainCategory(sub){ return SUB_TO_MAIN_CATEGORY_MAP[sub]||'其他成本'; }

// ===== 模态实例 =====
const recordModal = new bootstrap.Modal(document.getElementById('recordModal'));
const addClientModal = new bootstrap.Modal(document.getElementById('addClientModal'));
const deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
let recordToDelete = null;

// ===== 全局数据缓存（由 loadData 拉取并赋值） =====
let data = { clients: [], costRecords: [] };

// ===== 测试数据（来自你原文件，已把 client 用 name 标记以便首次插入时匹配） =====
function getInitData() {
  return {
    clients: [
      { name: "彭黎", start_date: "2025-06-09", type: "Pro版", quota: 150000 },
      { name: "潘&徐", start_date: "2025-04-20", type: "Pro版", quota: 240000 },
      { name: "王娴&王杰", start_date: "2025-07-01", type: "基础版", quota: 80000 },
      { name: "梅龙毅", start_date: "2025-06-26", type: "基础版", quota: 40000 },
      { name: "吴边", start_date: "2024-10-15", type: "基础版", quota: 40000 }
    ],
    costRecords: [
      { clientName: "彭黎", date: "2025-07-11", category: "定制补充剂成本", item_name: "第一季度定制补充剂", supplier: "袁名远", quantity: 1, unit_price: 2400, total_amount: 2400, notes: "无" },
      { clientName: "彭黎", date: "2025-07-11", category: "益生菌成本", item_name: "八周益生菌", supplier: "金裕", quantity: 1, unit_price: 2357, total_amount: 2357, notes: "2347，加上预估10元寄送运费" },
      { clientName: "彭黎", date: "2025-07-11", category: "抗衰设备使用成本", item_name: "每月10次设备使用（一年）", supplier: "广州时光派", quantity: 1, unit_price: 8000, total_amount: 8000, notes: "" },
      { clientName: "彭黎", date: "2025-07-11", category: "生物同源性荷尔蒙成本", item_name: "第一次荷尔蒙付款", supplier: "鲁博", quantity: 1, unit_price: 10677, total_amount: 10677, notes: "第一次面诊＋第一季度药费＋帮带费用" },

      { clientName: "潘&徐", date: "2025-05-09", category: "检测成本", item_name: "问题排查（包含各种检测）", supplier: "华测", quantity: 1, unit_price: 7200, total_amount: 7200, notes: "以下份数*2\n全套有机酸代谢分析\n营养与毒性元素分析\n混合过敏源20项\n上呼吸道感染EB病毒抗体检测四项\n病原抗体九项\n呼吸道核酸六联检\n肺炎支原体脱氧核糖核酸检测\n巨细胞病毒抗体IgM定量\n巨细胞病毒抗体IgG定量" },
      { clientName: "潘&徐", date: "2025-05-28", category: "检测成本", item_name: "16s肠道菌群检测", supplier: "金裕", quantity: 1, unit_price: 1566, total_amount: 1566, notes: "包含16s检测*2，含文印费、运费、耗材" },
      { clientName: "潘&徐", date: "2025-04-25", category: "检测成本", item_name: "时光尺3.0", supplier: "华测等", quantity: 1, unit_price: 14558, total_amount: 14558, notes: "成本*2" },
      { clientName: "潘&徐", date: "2025-04-25", category: "检测成本", item_name: "NAD+", supplier: "郎华", quantity: 1, unit_price: 450, total_amount: 450, notes: "检测+物流成本（225*2）" },
      { clientName: "彭黎", date: "2025-06-20", category: "检测成本", item_name: "16s肠道菌群检测", supplier: "金裕", quantity: 1, unit_price: 723, total_amount: 723, notes: "无文印费和报告邮寄费" },
      { clientName: "潘&徐", date: "2025-01-21", category: "拜访客户成本", item_name: "上门拜访", supplier: "交通", quantity: 1, unit_price: 880.09, total_amount: 880.09, notes: "火车票818元+徐方倩打车62.09元" },
      { clientName: "潘&徐", date: "2025-02-12", category: "额外采买好物成本", item_name: "液体钙", supplier: "淘宝", quantity: 1, unit_price: 917.5, total_amount: 917.5, notes: "" },
      { clientName: "潘&徐", date: "2025-01-21", category: "拜访客户成本", item_name: "低糖水果", supplier: "水果", quantity: 1, unit_price: 295.95, total_amount: 295.95, notes: "" },
      { clientName: "潘&徐", date: "2025-03-15", category: "拜访客户成本", item_name: "线下招待果切", supplier: "水果", quantity: 1, unit_price: 22.8, total_amount: 22.8, notes: "" },
      { clientName: "潘&徐", date: "2025-06-11", category: "额外采买好物成本", item_name: "益生菌含片", supplier: "淘宝", quantity: 1, unit_price: 765, total_amount: 765, notes: "for潘先生咽炎（总共买了好几盒" },
      { clientName: "潘&徐", date: "2025-06-05", category: "拜访客户成本", item_name: "线下拜访", supplier: "交通", quantity: 1, unit_price: 1098, total_amount: 1098, notes: "二人往返+打车" },
      { clientName: "潘&徐", date: "2025-07-20", category: "定制补充剂成本", item_name: "第一季度定制补充剂", supplier: "袁名远", quantity: 1, unit_price: 4800, total_amount: 4800, notes: "" },
      { clientName: "潘&徐", date: "2025-07-11", category: "益生菌成本", item_name: "2个月益生菌", supplier: "金裕", quantity: 1, unit_price: 3142, total_amount: 3142, notes: "3122+运费20" },
      { clientName: "潘&徐", date: "2025-05-12", category: "拜访客户成本", item_name: "拜访客户", supplier: "交通", quantity: 1, unit_price: 549.84, total_amount: 549.84, notes: "住宿99+往返车票184+185，返程打车约56" },

      { clientName: "王娴&王杰", date: "2025-07-11", category: "医疗方案成本", item_name: "医疗方案", supplier: "张医生", quantity: 1, unit_price: 1200, total_amount: 1200, notes: "600*2" },
      { clientName: "王娴&王杰", date: "2025-07-11", category: "定制补充剂成本", item_name: "第一季度定制补充剂", supplier: "袁名远", quantity: 1, unit_price: 4800, total_amount: 4800, notes: "" },

      { clientName: "梅龙毅", date: "2025-07-11", category: "定制补充剂成本", item_name: "第一季度定制补充剂", supplier: "袁名远", quantity: 1, unit_price: 2400, total_amount: 2400, notes: "" },
      { clientName: "梅龙毅", date: "2025-07-11", category: "医疗方案成本", item_name: "初次医疗方案", supplier: "张医生", quantity: 1, unit_price: 300, total_amount: 300, notes: "" },
      { clientName: "梅龙毅", date: "2025-07-11", category: "医疗方案成本", item_name: "3.0解读", supplier: "鲁博", quantity: 1, unit_price: 1500, total_amount: 1500, notes: "" },
      { clientName: "梅龙毅", date: "2025-07-11", category: "医疗方案成本", item_name: "转化提成", supplier: "鲁博", quantity: 1, unit_price: 600, total_amount: 600, notes: "" },
      { clientName: "梅龙毅", date: "2025-07-11", category: "医疗方案成本", item_name: "转化提成", supplier: "鲁博", quantity: 1, unit_price: 600, total_amount: 600, notes: "" },

      { clientName: "吴边", date: "2025-07-11", category: "定制补充剂成本", item_name: "三个季度定制补充剂", supplier: "袁名远", quantity: 1, unit_price: 7200, total_amount: 7200, notes: "" },
      { clientName: "吴边", date: "2025-06-26", category: "医疗方案成本", item_name: "线上回访", supplier: "张医生", quantity: 1, unit_price: 426.67, total_amount: 426.67, notes: "32min" }
    ]
  };
}

// ===== 初始化：如果数据库为空则导入测试数据（并保证 client->record 正确关联） =====
async function initDatabaseIfEmpty() {
  try {
    const { data: clients, error: cErr } = await supabaseClient.from('clients').select('id').limit(1);
    if (cErr) { console.error(cErr); return; }
    if (!clients || clients.length === 0) {
      const init = getInitData();
      // 插入 clients
      const { error: insertClientsErr } = await supabaseClient.from('clients').insert(init.clients);
      if (insertClientsErr) { console.error(insertClientsErr); return; }
      // 读取插入后的 clients，用 name->id 映射
      const { data: insertedClients } = await supabaseClient.from('clients').select('*');
      const nameToId = {};
      insertedClients.forEach(c => nameToId[c.name] = c.id);
      // 构造 cost_records（替换 clientName -> client_id）
      const recordsToInsert = init.costRecords.map(r => ({
        client_id: nameToId[r.clientName],
        date: r.date,
        category: r.category,
        item_name: r.item_name,
        supplier: r.supplier,
        quantity: r.quantity,
        unit_price: r.unit_price,
        total_amount: r.total_amount,
        notes: r.notes
      }));
      const { error: insertRecordsErr } = await supabaseClient.from('cost_records').insert(recordsToInsert);
      if (insertRecordsErr) console.error(insertRecordsErr);
    }
  } catch (err) {
    console.error('initDatabaseIfEmpty error', err);
  }
}

// ===== 从 Supabase 拉取数据并更新全局 data =====
async function loadData() {
  try {
    const { data: clients, error: cErr } = await supabaseClient.from('clients').select('*').order('id', { ascending: true });
    if (cErr) console.error(cErr);
    const { data: costRecords, error: rErr } = await supabaseClient.from('cost_records').select('*').order('date', { ascending: false });
    if (rErr) console.error(rErr);
    data.clients = clients || [];
    data.costRecords = costRecords || [];
  } catch (err) {
    console.error('loadData error', err);
  }
}

// ===== 渲染逻辑（基本沿用你原来的界面实现，字段名调整以匹配 DB） =====
function getClient(clientId) { return data.clients.find(c => c.id == clientId); }
function getClientQuota(client) {
  if (!client) return 0;
  if (client.quota) return Number(client.quota);
  if (client.name === '潘&徐') return 240000;
  if (client.name === '彭黎') return 150000;
  if (client.type && client.type.includes('Pro')) return 120000;
  return 40000;
}
const getClientSpent = (clientId) => data.costRecords.filter(r => r.client_id == clientId).reduce((s, r) => s + Number(r.total_amount), 0);
function getQuotaColor(spent, quota) {
  const percent = quota > 0 ? spent / quota : 0;
  if (percent >= 1) return '#e74c3c';
  if (percent >= 0.6) return '#f7b731';
  return '#2e7be6';
}

function renderAll() { renderDashboard(); }

function renderDashboard() {
  const dashboard = document.getElementById('dashboard');
  dashboard.innerHTML = '';
  data.clients.forEach(client => {
    const card = document.createElement('div');
    card.className = 'client-card';
    const quota = getClientQuota(client);
    const spent = getClientSpent(client.id);
    const remaining = quota - spent;
    const spentPercent = quota > 0 ? (spent / quota) * 100 : 0;
    const barColor = getQuotaColor(spent, quota);
    const spentRatio = quota > 0 ? spent / quota : 0;
    let alertBadge = '';
    if (spentRatio >= 1) alertBadge = '<span class="danger-badge">超额</span>';
    else if (spentRatio >= 0.6) alertBadge = '<span class="warning-badge">超60%</span>';

    card.innerHTML = `
      <div class="client-name" data-client-id="${client.id}">${client.name} ${alertBadge}</div>
      <div class="info-row">总额度: <b>￥${getClientQuota(client).toLocaleString()}</b></div>
      <div class="info-row">已花费: <b style="color: ${barColor};">￥${spent.toLocaleString()}</b></div>
      <div class="info-row">剩　余: <b style="color: #28a745;">￥${remaining.toLocaleString()}</b></div>
      <div class="client-pie"><canvas id="pie_${client.id}"></canvas></div>
      <div class="pie-label-container" id="pie_labels_${client.id}"></div>
      <div class="quota-bar-wrapper">
        <div class="quota-bar-bg">
          <div class="quota-bar-fill" style="background:${barColor}; width:${Math.min(100, spentPercent).toFixed(2)}%;"></div>
          <div class="quota-bar-text">${spentPercent.toFixed(1)}% 已用</div>
        </div>
      </div>
    `;
    dashboard.appendChild(card);
    // render pie after element attached
    setTimeout(()=> renderPieChart(client), 0);
  });

  const addCard = document.createElement('div');
  addCard.className = 'add-client-card';
  addCard.innerHTML = '+';
  addCard.onclick = () => addClientModal.show();
  dashboard.appendChild(addCard);
}

function renderPieChart(client) {
  const ctx = document.getElementById(`pie_${client.id}`);
  if (!ctx) return;
  const records = data.costRecords.filter(r => r.client_id == client.id);
  const mainCategoryMap = new Map();
  records.forEach(r => {
    const mainCat = getMainCategory(r.category);
    const currentTotal = mainCategoryMap.get(mainCat) || 0;
    mainCategoryMap.set(mainCat, currentTotal + Number(r.total_amount));
  });
  const labels = [...mainCategoryMap.keys()];
  const values = [...mainCategoryMap.values()];
  if (labels.length === 0) {
    ctx.parentElement.innerHTML = '<div style="color:#999;text-align:center;margin-top:70px;">暂无消费记录</div>';
    document.getElementById(`pie_labels_${client.id}`).innerHTML = '';
    return;
  }
  if (window[`pieChart_${client.id}`]) window[`pieChart_${client.id}`].destroy();
  window[`pieChart_${client.id}`] = new Chart(ctx, {
    type: 'doughnut',
    data: { labels, datasets: [{ data: values, backgroundColor: labels.map(l => CATEGORY_COLORS[l] || CATEGORY_COLORS['默认']), borderColor:'#fff', borderWidth:3 }]},
    options: { responsive:true, maintainAspectRatio:false, plugins: { legend:{display:false}, datalabels:{ display: (ctx)=> { const total = ctx.chart.getDatasetMeta(0).total; return (ctx.dataset.data[ctx.dataIndex] / total) > 0.05; }, color:'#fff', font:{weight:'bold', size:12}, formatter:(v,c)=> { const total = c.chart.getDatasetMeta(0).total; return (v/total*100).toFixed(0) + '%'; }, textStrokeColor:'#333', textStrokeWidth:2 } }, cutout: '60%' }, plugins:[ChartDataLabels]
  });
  const labelContainer = document.getElementById(`pie_labels_${client.id}`);
  labelContainer.innerHTML = labels.map(l => `<span class="pie-label" style="background-color:${CATEGORY_COLORS[l] || CATEGORY_COLORS['默认']}">${l}</span>`).join('');
}

function showClientDetail(clientId) {
  const client = getClient(clientId);
  if (!client) return;
  document.getElementById('main-view').style.display = 'none';
  document.getElementById('detail-view').style.display = 'block';
  document.getElementById('detail-title').textContent = `${client.name} - 消费明细`;
  document.getElementById('exportClientBtn').onclick = () => exportClientData(clientId);
  document.getElementById('exportExcelBtn').onclick = () => exportClientDataAsExcel(clientId);
  renderClientCostTable(clientId);
}
function hideClientDetail() { document.getElementById('main-view').style.display='block'; document.getElementById('detail-view').style.display='none'; renderAll(); }

function renderClientCostTable(clientId) {
  const tbody = document.getElementById('clientCostTableBody');
  tbody.innerHTML = '';
  const records = data.costRecords.filter(r => r.client_id == clientId);
  if (records.length === 0) { tbody.innerHTML = `<tr><td colspan="9" class="text-center p-4">暂无记录</td></tr>`; return; }
  records.sort((a,b)=> new Date(b.date)-new Date(a.date)).forEach(record => tbody.appendChild(createRecordRow(record)));
}
function createRecordRow(record) {
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>${record.date}</td>
    <td>${record.category}</td>
    <td>${record.item_name}</td>
    <td>${record.supplier || ''}</td>
    <td>${record.quantity}</td>
    <td>￥${Number(record.unit_price).toLocaleString()}</td>
    <td>￥${Number(record.total_amount).toLocaleString()}</td>
    <td>${record.notes || ''}</td>
    <td class="table-actions">
      <button class="btn btn-sm btn-outline-primary edit-btn" data-id="${record.id}">编辑</button>
      <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${record.id}">删除</button>
    </td>`;
  return tr;
}

// ===== 事件绑定 =====
document.getElementById('backToDashboardBtn').onclick = hideClientDetail;
document.getElementById('dashboard').addEventListener('click', e => {
  const cn = e.target.closest('.client-name');
  if (cn) showClientDetail(cn.dataset.clientId);
});

document.getElementById('addRecordBtn').onclick = async () => {
  await updateClientOptions();
  updateCategoryOptions();
  document.getElementById('recordForm').reset();
  document.getElementById('recordId').value = '';
  document.getElementById('recordModalTitle').textContent = '添加记录';
  document.getElementById('recordDate').valueAsDate = new Date();
  recordModal.show();
};

const quantityInput = document.getElementById('recordQuantity');
const unitPriceInput = document.getElementById('recordUnitPrice');
quantityInput.addEventListener('input', updateRecordTotal);
unitPriceInput.addEventListener('input', updateRecordTotal);
function updateRecordTotal(){ const q = parseFloat(quantityInput.value)||0; const p = parseFloat(unitPriceInput.value)||0; document.getElementById('recordTotalAmount').value = (q*p).toFixed(2); }

// ===== Supabase CRUD 操作（每次操作后我们重新 loadData() 并 renderAll() 以保证立即刷新） =====
async function insertClient(clientObj) {
  const { data: newClient, error } = await supabaseClient.from('clients').insert([clientObj]).select().single();
  if (error) throw error;
  return newClient;
}
async function insertRecord(recordObj) {
  const { data: newRecord, error } = await supabaseClient.from('cost_records').insert([recordObj]).select().single();
  if (error) throw error;
  return newRecord;
}
async function updateRecord(id, updates) {
  const { data: updated, error } = await supabaseClient.from('cost_records').update(updates).eq('id', id).select().single();
  if (error) throw error;
  return updated;
}
async function deleteRecord(id) {
  const { error } = await supabaseClient.from('cost_records').delete().eq('id', id);
  if (error) throw error;
}

// ===== 保存记录（添加/编辑）按钮 =====
document.getElementById('saveRecordBtn').onclick = async () => {
  const form = document.getElementById('recordForm');
  if (!form.checkValidity()) { form.reportValidity(); return; }
  const id = document.getElementById('recordId').value;
  const recordData = {
    client_id: Number(document.getElementById('recordClient').value),
    date: document.getElementById('recordDate').value,
    category: document.getElementById('recordCategory').value,
    item_name: document.getElementById('recordItemName').value.trim(),
    supplier: document.getElementById('recordSupplier').value.trim(),
    quantity: Number(document.getElementById('recordQuantity').value),
    unit_price: Number(document.getElementById('recordUnitPrice').value),
    total_amount: Number(document.getElementById('recordTotalAmount').value),
    notes: document.getElementById('recordNotes').value.trim()
  };
  try {
    if (id) {
      await updateRecord(Number(id), recordData);
    } else {
      await insertRecord(recordData);
    }
    await loadData(); renderAll();
    if (document.getElementById('detail-view').style.display === 'block') renderClientCostTable(recordData.client_id);
    recordModal.hide();
  } catch (err) { console.error(err); alert('保存失败：' + err.message); }
};

// 编辑 / 删除 按钮处理（由事件代理）
document.body.addEventListener('click', async e => {
  if (e.target.classList.contains('edit-btn')) {
    const id = e.target.dataset.id;
    const rec = data.costRecords.find(r => r.id == id);
    if (!rec) return;
    await updateClientOptions();
    updateCategoryOptions();
    document.getElementById('recordId').value = rec.id;
    document.getElementById('recordDate').value = rec.date;
    document.getElementById('recordClient').value = rec.client_id;
    document.getElementById('recordCategory').value = rec.category;
    document.getElementById('recordItemName').value = rec.item_name;
    document.getElementById('recordSupplier').value = rec.supplier;
    document.getElementById('recordQuantity').value = rec.quantity;
    document.getElementById('recordUnitPrice').value = rec.unit_price;
    document.getElementById('recordTotalAmount').value = rec.total_amount;
    document.getElementById('recordNotes').value = rec.notes;
    document.getElementById('recordModalTitle').textContent = '编辑记录';
    recordModal.show();
  }
  if (e.target.classList.contains('delete-btn')) {
    recordToDelete = e.target.dataset.id;
    deleteConfirmModal.show();
  }
});

document.getElementById('confirmDeleteBtn').onclick = async () => {
  if (!recordToDelete) { deleteConfirmModal.hide(); return; }
  try {
    const rec = data.costRecords.find(r => r.id == recordToDelete);
    await deleteRecord(Number(recordToDelete));
    await loadData(); renderAll();
    if (rec) renderClientCostTable(rec.client_id);
    recordToDelete = null;
    deleteConfirmModal.hide();
  } catch (err) { console.error(err); alert('删除失败：' + err.message); deleteConfirmModal.hide(); }
};

// ===== 新增客户 UI 逻辑 =====
document.getElementById('newClientType').addEventListener('change', e => {
  document.getElementById('manualQuotaWrapper').style.display = e.target.value === '特殊' ? 'block' : 'none';
});
document.getElementById('saveNewClientBtn').onclick = async () => {
  const name = document.getElementById('newClientName').value.trim();
  const type = document.getElementById('newClientType').value;
  let quota = null;
  if (type === '特殊') {
    quota = parseFloat(document.getElementById('newClientQuota').value);
    if (isNaN(quota) || quota <= 0) { alert('请为特殊类型客户填写有效的额度！'); return; }
  }
  if (!name) { alert('请填写客户姓名！'); return; }
  const newClient = { name, type };
  if (quota) newClient.quota = quota;
  try {
    await insertClient(newClient);
    await loadData(); renderAll();
    addClientModal.hide();
    document.getElementById('newClientName').value = '';
    document.getElementById('newClientQuota').value = '';
    document.getElementById('manualQuotaWrapper').style.display = 'none';
  } catch (err) { console.error(err); alert('添加客户失败：' + err.message); }
};

// ===== 更新客户选项下拉（调用时确保 data.clients 已加载） =====
async function updateClientOptions() {
  const sel = document.getElementById('recordClient');
  const currentVal = sel.value;
  sel.innerHTML = '';
  data.clients.forEach(c => {
    const opt = document.createElement('option'); opt.value = c.id; opt.textContent = c.name; sel.appendChild(opt);
  });
  sel.value = currentVal || (data.clients[0] ? data.clients[0].id : '');
}
function updateCategoryOptions() {
  const sel = document.getElementById('recordCategory'); sel.innerHTML = '';
  for (const mainCat in CATEGORY_STRUCTURE) {
    const optGroup = document.createElement('optgroup'); optGroup.label = mainCat;
    CATEGORY_STRUCTURE[mainCat].forEach(sub => { const opt = document.createElement('option'); opt.value = sub; opt.textContent = sub; optGroup.appendChild(opt); });
    sel.appendChild(optGroup);
  }
}

// ===== 导入/导出（导出 JSON/Excel 与导入 JSON） =====
document.getElementById('importBtn').onclick = () => document.getElementById('importFile').click();
document.getElementById('exportBtn').onclick = () => exportData({ clients: data.clients, costRecords: data.costRecords }, 'TimeCure_数据备份');

function exportData(exportObj, baseFileName) {
  const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url;
  a.download = `${baseFileName}_${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
}

function exportClientData(clientId) {
  const client = getClient(clientId);
  const clientRecords = data.costRecords.filter(r => r.client_id == clientId);
  const exportObj = { clients: [client], costRecords: clientRecords };
  exportData(exportObj, `TimeCure_${client.name}_明细`);
}

function exportClientDataAsExcel(clientId) {
  const client = getClient(clientId);
  const records = data.costRecords.filter(r => r.client_id == clientId).sort((a,b)=> new Date(b.date)-new Date(a.date));
  if (!client || records.length === 0) { alert('没有可导出的数据。'); return; }
  const headers = ['日期','分类','项目','供应商','数量','单价','总额','备注'];
  const dataForSheet = records.map(r => [r.date, r.category, r.item_name, r.supplier || '', r.quantity, r.unit_price, r.total_amount, r.notes || '']);
  const totalSpent = records.reduce((s,r)=>s + Number(r.total_amount),0);
  dataForSheet.push([]); dataForSheet.push(['','','','','','总计', totalSpent, '']);
  const ws = XLSX.utils.aoa_to_sheet([headers, ...dataForSheet]);
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, '消费明细');
  const fileName = `TimeCure_${client.name}_明细_${new Date().toISOString().slice(0,10)}.xlsx`;
  XLSX.writeFile(wb, fileName);
}

// 导入 JSON（会直接覆盖数据库：先清空后插入）
// **提示**：此处为覆盖式导入，谨慎使用
document.getElementById('importFile').onchange = async (e) => {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = async (ev) => {
    try {
      const imported = JSON.parse(ev.target.result);
      if (!Array.isArray(imported.clients) || !Array.isArray(imported.costRecords)) throw new Error('数据格式不正确，需包含 clients 与 costRecords 数组。');
      // 清空表（谨慎）
      await supabaseClient.from('cost_records').delete().neq('id', 0);
      await supabaseClient.from('clients').delete().neq('id', 0);
      // 插入 clients
      await supabaseClient.from('clients').insert(imported.clients);
      const { data: newClients } = await supabaseClient.from('clients').select('*');
      const nameToId = {}; newClients.forEach(c=> nameToId[c.name]=c.id);
      // 替换 client_id 并插入 cost_records
      const recs = imported.costRecords.map(r=>{
        return { client_id: nameToId[r.clientName] || r.client_id || null, date:r.date, category:r.category || r.itemName || r.item_name, item_name: r.item_name || r.itemName || r.itemName, supplier:r.supplier || '', quantity:r.quantity||0, unit_price:r.unit_price||r.unitPrice||0, total_amount:r.total_amount||r.totalAmount||0, notes:r.notes||r.note||'' };
      }).filter(r => r.client_id);
      await supabaseClient.from('cost_records').insert(recs);
      await loadData(); renderAll();
      alert('导入成功（已覆盖数据库）');
    } catch (err) { alert('导入失败：' + err.message); }
  };
  reader.readAsText(file); e.target.value = '';
};

// ===== 页面初始化流程 =====
(async () => {
  // 1) 若 tables 空则导入测试数据（第一次访问）
  await initDatabaseIfEmpty();
  // 2) load data & render
  await loadData();
  renderAll();
})();

</script>
</body>
</html>
